
import urllib2, traceback, time

location = None

class MyHTTPRedirectHandler(urllib2.HTTPRedirectHandler):
    def http_error_302(self, req, fp, code, msg, headers):
        Log("cccccccccccccccccccCookie Manip Right Here")
        Log(headers)
        global location
        location = headers['Location']
        return urllib2.HTTPRedirectHandler.http_error_302(self, req, fp, code, msg, headers)

    http_error_301 = http_error_303 = http_error_307 = http_error_302


def MediaObjectsForURL(url):
    Log('service : %s', url)
    try:
        if url.find('/video.mp4/') != -1:
            part = PartObject(key=url.split('/video.mp4/')[1], container='mp4', optimized_for_streaming=True)
            part.streams.append(VideoStreamObject(codec=VideoCodec.H264))
            part.streams.append(AudioStreamObject(codec=AudioCodec.AAC, channels=2))
            return [MediaObject(parts=[part], container='mp4', video_codec=VideoCodec.H264, audio_codec=AudioCodec.AAC)]
       
        elif url.find('/ott/') != -1:
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=Callback(PlayVideoOtt, url=url.split('/ott/')[1]),
                            container='mpegts', 
                        )
                    ],
                    #protocol="hls",
                    container='mpegts', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                )
            ]
        elif url.find('/redirect.m3u8/') != -1:
            tmp = url.split('/redirect.m3u8/')[1]
            mode, param = tmp.split('|')
            if mode == 'tving':
                redirect_url = param
            elif mode == 'wavve':
                import urllib
                param = urllib.quote(param)
                Log('3333333333333333333333333')
                Log(param)
                redirect_url = '/:/plugins/com.plexapp.agents.sjva_agent/function/wavve?sjva_url=%s' % param
                #redirect_url = 'https://vod.cdn.wavve.com/hls/M01/M_1003704100074100000.1/2/chunklist5000.m3u8?authtoken=a5d-yfS36R7qLlgeDI_IW1OoQ0M6v-apk1oHukSjnmTsVF9aSckKf0xDKzFP2-yjLYWxwNTkIvvxZHRm_8kcLCe5yUh5B3TV7rk440x-nfTBvgJtFp3wp94zYGurWjwjMhkfBtbxQG7PKjGgwwLV1Lr85oG7v2n7AvcdnLrxbXS1cX-1x5pfyCtsh2wtmGIgSyD7LyqdneVZE3TcEp8'
            Log('redirect_url : %s', redirect_url)

            """
            part = PartObject(key=redirect_url, container='mpegts', optimized_for_streaming=True)
            part.streams.append(VideoStreamObject(codec=VideoCodec.H264))
            part.streams.append(AudioStreamObject(codec=AudioCodec.AAC))
            return [MediaObject(parts=[part], protocol="hls", container='mpegts', video_codec=VideoCodec.H264, audio_codec=AudioCodec.AAC)]
            """
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=redirect_url,
                            container='mpegts', 
                        )
                    ],
                    protocol="hls",
                    container='mpegts', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                    #video_resolution = 'sd', #ios 튕김
                )
            ]
        elif url.find('/redirect.mp4/') != -1:
            tmp = url.split('/redirect.mp4/')[1]
            mode, param = tmp.split('|')
            if mode == 'kakao':
                redirect_url = '/:/plugins/com.plexapp.agents.sjva_agent/function/kakao?content_id=%s' % param
            elif mode in ['naver', 'youtube']:
                redirect_url = param
            
            Log('redirect_url : %s', redirect_url)
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=redirect_url,
                            container='mp4', 
                        )
                    ],
                    #protocol="hls",
                    container='mp4', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                )
            ]


    except Exception as e: 
        Log('Exception:%s', e)
        Log(traceback.format_exc())




@indirect
def PlayVideoOtt(url, **kwargs):
    url = url.split('|')[1]
    data = JSON.ObjectFromURL(url)
    if data['site'] == 'tving':
        video_url = data['url']
    elif data['site'] == 'wavve':
        url = data['url']
        data = JSON.ObjectFromURL(url)
        video_url = data['playurl'].replace('chunklist5000.m3u8', '5000/chunklist.m3u8')
    Log(video_url)
    return IndirectResponse(VideoClipObject, key=video_url)
    #return IndirectResponse(VideoClipObject, key=HTTPLiveStreamURL(video_url))


"""
IOS : hls, mpegts 아니면 튕김 - 트랜스코딩
"""