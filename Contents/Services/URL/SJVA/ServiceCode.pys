
import urllib2, traceback, time

location = None

class MyHTTPRedirectHandler(urllib2.HTTPRedirectHandler):
    def http_error_302(self, req, fp, code, msg, headers):
        Log("cccccccccccccccccccCookie Manip Right Here")
        Log(headers)
        global location
        location = headers['Location']
        return urllib2.HTTPRedirectHandler.http_error_302(self, req, fp, code, msg, headers)

    http_error_301 = http_error_303 = http_error_307 = http_error_302


def MediaObjectsForURL(url):
    Log('service : %s', url)
    try:
        if url.find('/video.mp4/') != -1:
            part = PartObject(key=url.split('/video.mp4/')[1], container='mp4', optimized_for_streaming=True)
            part.streams.append(VideoStreamObject(codec=VideoCodec.H264))
            part.streams.append(AudioStreamObject(codec=AudioCodec.AAC, channels=2))
            return [MediaObject(parts=[part], container='mp4', video_codec=VideoCodec.H264, audio_codec=AudioCodec.AAC)]
       
        elif url.find('/ott/') != -1:
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=Callback(PlayVideoOtt, url=url.split('/ott/')[1]),
                            container='mpegts', 
                        )
                    ],
                    #protocol="hls",
                    container='mpegts', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                )
            ]
        elif url.find('/redirect.m3u8/') != -1:

            tmp = url.split('/redirect.m3u8/')[1]
            mode, param = tmp.split('|')
            if mode == 'tving':
                redirect_url = param
            elif mode == 'wavve':
                import urllib
                param = urllib.quote(param)
                redirect_url = '/:/plugins/com.plexapp.agents.sjva_agent/function/wavve?sjva_url=%s' % param
            
            Log('redirect_url : %s', redirect_url)

            """
            part = PartObject(key=redirect_url, container='mpegts')
            Log(part)
            #Log(part.file)
            #part.width = 1920
            Log('--------------------------')
            #part.streams.append(VideoStreamObject(codec=VideoCodec.H264, width = 1920,
            height = 1080))
            #part.streams.append(AudioStreamObject(codec=AudioCodec.AAC, channels=2))
            media = MediaObject(parts=[part], protocol="hls", container='mpegts', video_codec=VideoCodec.H264, audio_codec=AudioCodec.AAC, optimized_for_streaming = True, width=1920, height=1080)
            Log('====================')

            Log(part)
            #part.set_default_attr('width', '1080')
            Log(media.to_xml())
            tmp = media.to_xml()
            #import pyamf
            #from pyamf import xml
            #xml.tostring(tmp)
            return [media]
            """

            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=redirect_url,
                            container='mpegts', 
                        )
                    ],
                    protocol="hls",
                    container='mpegts', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                    #video_resolution = 'sd', #ios 튕김
                )
            ]
            
        elif url.find('/redirect.mp4/') != -1:
            tmp = url.split('/redirect.mp4/')[1]
            mode, param = tmp.split('|')
            if mode in ['naver', 'youtube', 'kakao']:
                redirect_url = param
            Log('redirect_url : %s', redirect_url)
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=redirect_url,
                            container='mp4', 
                        )
                    ],
                    container='mp4', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                )
            ]
        elif url.find('/wavve_movie/') != -1:
            return [
                MediaObject(
                    parts = [
                        PartObject(
                            key=Callback(PlayVideoOtt2, url=url.split('/wavve_movie/')[1]),
                            container='mpegts', 
                        )
                    ],
                    #protocol="hls",
                    container='mpegts', 
                    video_codec=VideoCodec.H264, 
                    audio_codec=AudioCodec.AAC,
                    optimized_for_streaming = True,
                )
            ]

    except Exception as e: 
        Log('Exception:%s', e)
        Log(traceback.format_exc())




@indirect
def PlayVideoOtt(url, **kwargs):
    url = url.split('|')[1]
    data = JSON.ObjectFromURL(url)
    if data['site'] == 'tving':
        video_url = data['url']
    elif data['site'] == 'wavve':
        url = data['url']
        data = JSON.ObjectFromURL(url)
        video_url = data['playurl'].replace('chunklist5000.m3u8', '5000/chunklist.m3u8')
    Log(video_url)
    return IndirectResponse(VideoClipObject, key=video_url)
    #return IndirectResponse(VideoClipObject, key=HTTPLiveStreamURL(video_url))


@indirect
def PlayVideoOtt2(url, **kwargs):
    data = JSON.ObjectFromURL(url)
    video_url = data['playurl'].replace('chunklist5000.m3u8', '5000/chunklist.m3u8')
    Log(video_url)
    return IndirectResponse(VideoClipObject, key=video_url)
    #return IndirectResponse(VideoClipObject, key=HTTPLiveStreamURL(video_url))



"""
IOS : hls, mpegts 아니면 튕김 - 트랜스코딩
"""